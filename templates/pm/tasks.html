{% extends 'pm/base.html' %}

{% block page_title %}Task Management{% endblock %}

{% block content %}
<!-- View Toggle and Filters -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
        <div class="flex space-x-2">
            <button id="listViewBtn" class="view-active px-4 py-2 rounded-lg flex items-center bg-dark-teal text-white">
                <i class="fas fa-list mr-2"></i>
                <span>List View</span>
            </button>
            <button id="boardViewBtn" class="px-4 py-2 bg-gray-100 rounded-lg flex items-center hover:bg-gray-200 transition text-gray-700">
                <i class="fas fa-th-large mr-2"></i>
                <span>Board View</span>
            </button>
        </div>
        
        <div class="flex flex-wrap gap-2">
            <a href="{% url 'pm_tasks' %}" class="{% if not status_filter %}filter-active{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-sm transition {% if not status_filter %}bg-dark-teal text-white{% else %}hover:bg-gray-200{% endif %}">
                All Tasks
            </a>
            <a href="{% url 'pm_tasks' %}?status=todo" class="{% if status_filter == 'todo' %}filter-active{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-sm transition {% if status_filter == 'todo' %}bg-dark-teal text-white{% else %}hover:bg-gray-200{% endif %}">
                To Do
            </a>
            <a href="{% url 'pm_tasks' %}?status=in_progress" class="{% if status_filter == 'in_progress' %}filter-active{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-sm transition {% if status_filter == 'in_progress' %}bg-dark-teal text-white{% else %}hover:bg-gray-200{% endif %}">
                In Progress
            </a>
            <a href="{% url 'pm_tasks' %}?status=review" class="{% if status_filter == 'review' %}filter-active{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-sm transition {% if status_filter == 'review' %}bg-dark-teal text-white{% else %}hover:bg-gray-200{% endif %}">
                In Review
            </a>
            <a href="{% url 'pm_tasks' %}?status=done" class="{% if status_filter == 'done' %}filter-active{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-sm transition {% if status_filter == 'done' %}bg-dark-teal text-white{% else %}hover:bg-gray-200{% endif %}">
                Done
            </a>
        </div>
        
        <div class="flex space-x-3 w-full md:w-auto">
            <form method="GET" action="{% url 'pm_tasks' %}" class="flex flex-wrap gap-3">
                <div class="relative flex-1 md:w-64">
                    <input type="text" name="search" placeholder="Search tasks..." value="{{ search_query }}" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-teal">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <select name="project" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-teal">
                    <option value="">All Projects</option>
                    {% for project in managed_projects %}
                        <option value="{{ project.id }}" {% if project_filter == project.id|stringformat:"i" %}selected{% endif %}>{{ project.name }}</option>
                    {% endfor %}
                </select>
                <select name="priority" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-teal">
                    <option value="">All Priorities</option>
                    <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
                    <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                    <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                    <option value="critical" {% if priority_filter == 'critical' %}selected{% endif %}>Critical</option>
                </select>
                <button type="submit" class="px-4 py-2 bg-dark-teal text-white rounded-lg hover:bg-dark-cyan flex items-center">
                    <i class="fas fa-filter mr-2"></i>
                    <span>Apply</span>
                </button>
                <a href="{% url 'pm_tasks' %}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center">
                    <i class="fas fa-redo mr-2"></i>
                    <span>Reset</span>
                </a>
            </form>
        </div>
    </div>
</div>

<!-- Task Statistics -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-gray-500 text-sm">Total Tasks</p>
                <h3 class="text-2xl font-bold text-ink-black mt-1">{{ total_tasks_count }}</h3>
            </div>
            <div class="p-3 bg-dark-teal bg-opacity-10 rounded-lg">
                <i class="fas fa-tasks text-dark-teal text-xl"></i>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4"><span class="text-dark-cyan font-medium">{{ active_tasks_count }} active</span></p>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-gray-500 text-sm">Overdue</p>
                <h3 class="text-2xl font-bold text-ink-black mt-1">{{ overdue_tasks_count }}</h3>
            </div>
            <div class="p-3 bg-rusty-spice bg-opacity-10 rounded-lg">
                <i class="fas fa-exclamation-circle text-rusty-spice text-xl"></i>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4">
            <span class="text-rusty-spice font-medium">Need attention</span>
        </p>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-gray-500 text-sm">Due This Week</p>
                <h3 class="text-2xl font-bold text-ink-black mt-1">{{ due_this_week_count }}</h3>
            </div>
            <div class="p-3 bg-golden-orange bg-opacity-10 rounded-lg">
                <i class="fas fa-calendar-week text-golden-orange text-xl"></i>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4">
            <span class="text-dark-cyan font-medium">{{ high_priority_week_count }} high priority</span>
        </p>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-gray-500 text-sm">Completed</p>
                <h3 class="text-2xl font-bold text-ink-black mt-1">{{ completed_tasks_count }}</h3>
            </div>
            <div class="p-3 bg-pearl-aqua bg-opacity-10 rounded-lg">
                <i class="fas fa-check-circle text-pearl-aqua text-xl"></i>
            </div>
        </div>
        <p class="text-xs text-gray-500 mt-4">
            <span class="text-dark-cyan font-medium">This month</span>
        </p>
    </div>
</div>

                    
    
    {% if tasks %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignee</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for task in tasks %}
                <tr class="hover:bg-gray-50 transition" data-task-id="{{ task.id }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 bg-dark-teal bg-opacity-10 rounded-lg flex items-center justify-center">
                                {% if task.task_type == 'bug' %}
                                <i class="fas fa-bug text-rusty-spice"></i>
                                {% elif task.task_type == 'feature' %}
                                <i class="fas fa-star text-dark-teal"></i>
                                {% elif task.task_type == 'improvement' %}
                                <i class="fas fa-wrench text-golden-orange"></i>
                                {% else %}
                                <i class="fas fa-tasks text-dark-teal"></i>
                                {% endif %}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ task.title }}</div>
                                <div class="text-sm text-gray-500">#TASK-{{ task.id }}{% if task.subtasks_total and task.subtasks_total > 0 %} &middot; Subtasks: {{ task.subtasks_completed }}/{{ task.subtasks_total }} ({{ task.progress }}%){% endif %}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ task.project.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if task.assigned_to %}
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-dark-teal flex items-center justify-center text-white text-xs font-bold">
                                {{ task.assigned_to.user.first_name|first }}{{ task.assigned_to.user.last_name|first }}
                            </div>
                            <div class="ml-2 text-sm font-medium">{{ task.assigned_to.user.get_full_name }}</div>
                        </div>
                        {% else %}
                        <span class="text-sm text-gray-500">Unassigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm {% if task.due_date < today and task.status != 'done' %}text-rusty-spice{% else %}text-gray-500{% endif %}">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-alt mr-1 text-gray-400"></i>
                            <span>
                                {{ task.due_date|date:"M d, Y" }}
                                {% if task.due_date < today and task.status != 'done' %}(Overdue){% endif %}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full priority-{{ task.priority }}">
                            {{ task.get_priority_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full status-{{ task.status }} {% if task.status == 'todo' %}bg-golden-orange bg-opacity-10 text-golden-orange{% elif task.status == 'in_progress' %}bg-dark-cyan bg-opacity-10 text-dark-cyan{% elif task.status == 'review' %}bg-rusty-spice bg-opacity-10 text-rusty-spice{% elif task.status == 'done' %}bg-pearl-aqua bg-opacity-10 text-pearl-aqua{% endif %}">
                            {{ task.get_status_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-dark-teal hover:text-dark-cyan mr-3 edit-task" data-id="{{ task.id }}" title="Edit Task">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% if task.status == 'review' %}
                        <button class="text-dark-teal hover:text-dark-cyan mr-3 approve-task" data-id="{{ task.id }}" title="Approve Task">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="text-rusty-spice hover:text-oxidized-iron request-changes" data-id="{{ task.id }}" title="Request Changes">
                            <i class="fas fa-redo"></i>
                        </button>
                        {% endif %}
                        
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
        <div class="flex justify-between items-center">
            <div class="text-sm text-gray-500">
                Showing <span class="font-medium">{{ tasks.count }}</span> of <span class="font-medium">{{ total_tasks_count }}</span> tasks
            </div>
            <!-- Pagination would go here -->
        </div>
    </div>
    {% else %}
    <div class="p-12 text-center">
        <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
            <i class="fas fa-tasks text-gray-400 text-3xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No tasks found</h3>
        <p class="text-gray-500 mb-6">Try adjusting your filters or create a new task</p>
        <button id="showNewTaskModal" class="bg-dark-teal text-white px-6 py-3 rounded-lg flex items-center mx-auto hover:bg-dark-cyan">
            <i class="fas fa-plus mr-2"></i>
            <span>Create New Task</span>
        </button>
    </div>
    {% endif %}
</div>

<!-- Board View (Hidden by Default) - Fixed Vertical Layout -->
<div id="boardView" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- To Do Column -->
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-golden-orange mr-2"></div>
                    <h3 class="font-semibold text-ink-black">To Do</h3>
                </div>
                <span class="bg-white px-2 py-1 rounded-full text-xs font-medium">{{ todo_tasks_count }}</span>
            </div>
            <div class="space-y-4 h-full">
                {% for task in todo_tasks %}
                <div class="bg-white rounded-lg p-4 shadow-sm task-card task-status-todo border-l-4 border-golden-orange" data-task-id="{{ task.id }}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-sm">{{ task.title|truncatechars:40 }}</h4>
                        <span class="text-xs priority-{{ task.priority }} px-2 py-1 rounded-full">{{ task.get_priority_display|slice:":1" }}</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-3 truncate">{{ task.description|truncatechars:60|default:"No description" }}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            {% if task.assigned_to %}
                            <div class="w-6 h-6 rounded-full bg-dark-teal flex items-center justify-center text-white text-xs">
                                {{ task.assigned_to.user.first_name|first }}{{ task.assigned_to.user.last_name|first }}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">{{ task.assigned_to.user.first_name }}</span>
                            {% else %}
                            <span class="text-xs text-gray-500">Unassigned</span>
                            {% endif %}
                        </div>
                        <span class="text-xs {% if task.due_date < today %}text-rusty-spice{% else %}text-gray-500{% endif %}">
                            {{ task.due_date|date:"M d" }}
                        </span>
                    </div>
                    <div class="mt-3 flex space-x-1">
                        <button class="text-xs text-dark-teal hover:text-dark-cyan edit-task" data-id="{{ task.id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                       
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-clipboard-list text-2xl mb-2"></i>
                    <p class="text-sm">No tasks</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- In Progress Column -->
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-dark-cyan mr-2"></div>
                    <h3 class="font-semibold text-ink-black">In Progress</h3>
                </div>
                <span class="bg-white px-2 py-1 rounded-full text-xs font-medium">{{ in_progress_tasks_count }}</span>
            </div>
            <div class="space-y-4 h-full">
                {% for task in in_progress_tasks %}
                <div class="bg-white rounded-lg p-4 shadow-sm task-card task-status-progress border-l-4 border-dark-cyan" data-task-id="{{ task.id }}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-sm">{{ task.title|truncatechars:40 }}</h4>
                        <span class="text-xs priority-{{ task.priority }} px-2 py-1 rounded-full">{{ task.get_priority_display|slice:":1" }}</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-3 truncate">{{ task.description|truncatechars:60|default:"No description" }}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            {% if task.assigned_to %}
                            <div class="w-6 h-6 rounded-full bg-dark-teal flex items-center justify-center text-white text-xs">
                                {{ task.assigned_to.user.first_name|first }}{{ task.assigned_to.user.last_name|first }}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">{{ task.assigned_to.user.first_name }}</span>
                            {% endif %}
                        </div>
                        <span class="text-xs {% if task.due_date < today %}text-rusty-spice{% else %}text-gray-500{% endif %}">
                            {{ task.due_date|date:"M d" }}
                        </span>
                    </div>
                    {% if task.progress > 0 %}
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Progress</span>
                            <span>{{ task.progress }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-dark-cyan h-2 rounded-full" style="width: {{ task.progress }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-spinner text-2xl mb-2"></i>
                    <p class="text-sm">No tasks</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- In Review Column -->
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-rusty-spice mr-2"></div>
                    <h3 class="font-semibold text-ink-black">In Review</h3>
                </div>
                <span class="bg-white px-2 py-1 rounded-full text-xs font-medium">{{ review_tasks_count }}</span>
            </div>
            <div class="space-y-4 h-full">
                {% for task in review_tasks %}
                <div class="bg-white rounded-lg p-4 shadow-sm task-card task-status-review border-l-4 border-rusty-spice" data-task-id="{{ task.id }}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-sm">{{ task.title|truncatechars:40 }}</h4>
                        <span class="text-xs priority-{{ task.priority }} px-2 py-1 rounded-full">{{ task.get_priority_display|slice:":1" }}</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-3 truncate">{{ task.description|truncatechars:60|default:"No description" }}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            {% if task.assigned_to %}
                            <div class="w-6 h-6 rounded-full bg-golden-orange flex items-center justify-center text-white text-xs">
                                {{ task.assigned_to.user.first_name|first }}{{ task.assigned_to.user.last_name|first }}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">{{ task.assigned_to.user.first_name }}</span>
                            {% endif %}
                        </div>
                        <span class="text-xs {% if task.due_date < today %}text-rusty-spice{% else %}text-gray-500{% endif %}">
                            {{ task.due_date|date:"M d" }}
                        </span>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button class="flex-1 px-2 py-1 bg-dark-teal text-white text-xs rounded hover:bg-dark-cyan approve-task" data-id="{{ task.id }}">
                            <i class="fas fa-check mr-1"></i>Approve
                        </button>
                        <button class="flex-1 px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 request-changes" data-id="{{ task.id }}">
                            <i class="fas fa-redo mr-1"></i>Changes
                        </button>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-eye text-2xl mb-2"></i>
                    <p class="text-sm">No tasks</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Done Column -->
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-pearl-aqua mr-2"></div>
                    <h3 class="font-semibold text-ink-black">Done</h3>
                </div>
                <span class="bg-white px-2 py-1 rounded-full text-xs font-medium">{{ done_tasks_count }}</span>
            </div>
            <div class="space-y-4 h-full">
                {% for task in done_tasks %}
                <div class="bg-white rounded-lg p-4 shadow-sm task-card task-status-done border-l-4 border-pearl-aqua" data-task-id="{{ task.id }}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium text-sm">{{ task.title|truncatechars:40 }}</h4>
                        <span class="text-xs priority-{{ task.priority }} px-2 py-1 rounded-full">{{ task.get_priority_display|slice:":1" }}</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-3 truncate">{{ task.description|truncatechars:60|default:"No description" }}</p>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            {% if task.assigned_to %}
                            <div class="w-6 h-6 rounded-full bg-rusty-spice flex items-center justify-center text-white text-xs">
                                {{ task.assigned_to.user.first_name|first }}{{ task.assigned_to.user.last_name|first }}
                            </div>
                            <span class="text-xs text-gray-500 ml-1">{{ task.assigned_to.user.first_name }}</span>
                            {% endif %}
                        </div>
                        <span class="text-xs text-gray-500">
                            {% if task.completed_at %}
                            {{ task.completed_at|date:"M d" }}
                            {% else %}
                            Completed
                            {% endif %}
                        </span>
                    </div>
                    <div class="mt-3 flex justify-between text-xs text-gray-500">
                        <span>Actual: {{ task.actual_hours|default:"0" }}h</span>
                        <span>Est: {{ task.estimated_hours|default:"0" }}h</span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-400">
                    <i class="fas fa-check-circle text-2xl mb-2"></i>
                    <p class="text-sm">No tasks</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="editTaskModal" class="modal">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200">
            <h3 id="editTaskTitle" class="text-xl font-bold text-ink-black">Edit Task</h3>
        </div>
        <div class="p-6">
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Task Title *</label>
                        <input type="text" id="editTaskTitleInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Project *</label>
                        <select id="editTaskProject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required>
                            <option value="">Select Project</option>
                            {% for project in managed_projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="editTaskDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assigned To</label>
                        <select id="editTaskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal">
                            <option value="">Unassigned</option>
                            {% for member in project_members %}
                            <option value="{{ member.employee.id }}">{{ member.employee.user.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Task Type</label>
                        <select id="editTaskType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal">
                            <option value="feature">Feature</option>
                            <option value="bug">Bug</option>
                            <option value="improvement">Improvement</option>
                            <option value="research">Research</option>
                            <option value="documentation">Documentation</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority *</label>
                        <select id="editTaskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date *</label>
                        <input type="date" id="editTaskDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select id="editTaskStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required>
                            <option value="todo">To Do</option>
                            <option value="in_progress">In Progress</option>
                            <option value="review">In Review</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Hours</label>
                        <input type="number" id="editTaskEstimatedHours" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" min="0" max="200" step="0.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Actual Hours</label>
                        <input type="number" id="editTaskActualHours" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" min="0" max="200" step="0.5">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Progress (%)</label>
                    <input type="range" id="editTaskProgress" min="0" max="100" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-sm text-gray-500 mt-1">
                        <span>0%</span>
                        <span id="editTaskProgressValue">50%</span>
                        <span>100%</span>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelEditTaskBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-dark-teal text-white rounded-md hover:bg-dark-cyan">Update Task</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// API URL templates
const approveTaskApiUrl = "{% url 'approve_task_api' 0 %}";
const getTaskApiUrl = "{% url 'get_task_details_api' 0 %}";
const updateTaskApiUrl = "{% url 'update_task_api' 0 %}";
// View toggle functionality
const listViewBtn = document.getElementById('listViewBtn');
const boardViewBtn = document.getElementById('boardViewBtn');
const listView = document.getElementById('listView');
const boardView = document.getElementById('boardView');

if (listViewBtn && boardViewBtn) {
    listViewBtn.addEventListener('click', function() {
        listView.classList.remove('hidden');
        boardView.classList.add('hidden');
        listViewBtn.classList.remove('bg-gray-100', 'text-gray-700');
        listViewBtn.classList.add('bg-dark-teal', 'text-white');
        boardViewBtn.classList.remove('bg-dark-teal', 'text-white');
        boardViewBtn.classList.add('bg-gray-100', 'text-gray-700');
    });

    boardViewBtn.addEventListener('click', function() {
        listView.classList.add('hidden');
        boardView.classList.remove('hidden');
        boardViewBtn.classList.remove('bg-gray-100', 'text-gray-700');
        boardViewBtn.classList.add('bg-dark-teal', 'text-white');
        listViewBtn.classList.remove('bg-dark-teal', 'text-white');
        listViewBtn.classList.add('bg-gray-100', 'text-gray-700');
    });
}

// Edit task functionality
document.addEventListener('DOMContentLoaded', function() {
    // Edit task buttons
    document.querySelectorAll('.edit-task').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-id');
            loadTaskForEditing(taskId);
        });
    });
    
    
    
    // Approve task buttons
    document.querySelectorAll('.approve-task').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-id');
            
            // Set confirmation modal content
            document.getElementById('confirmationTitle').textContent = 'Approve Task';
            document.getElementById('confirmationMessage').textContent = `Are you sure you want to approve this task?`;
            
            // Set confirm action
            document.getElementById('confirmActionBtn').onclick = function() {
                approveTask(taskId);
            };
            
            showModal(document.getElementById('confirmationModal'));
        });
    });
    
    // Request changes buttons
    document.querySelectorAll('.request-changes').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-id');
            document.getElementById('changeTaskId').value = taskId;
            
            // Fetch task details for modal
            fetch(`/api/tasks/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('changeTaskTitle').textContent = data.task_title;
                        document.getElementById('changeTaskAssignee').textContent = data.assignee || 'Unassigned';
                    }
                });
            
            showModal(document.getElementById('requestChangesModal'));
        });
    });
    
    // Progress slider
    const progressSlider = document.getElementById('editTaskProgress');
    const progressValue = document.getElementById('editTaskProgressValue');
    
    if (progressSlider && progressValue) {
        progressSlider.addEventListener('input', function() {
            progressValue.textContent = this.value + '%';
        });
    }
    
    // Edit task form submission
    const editTaskForm = document.getElementById('editTaskForm');
    if (editTaskForm) {
        editTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            updateTask();
        });
    }
    
    // Cancel edit task button
    const cancelEditTaskBtn = document.getElementById('cancelEditTaskBtn');
    if (cancelEditTaskBtn) {
        cancelEditTaskBtn.addEventListener('click', function() {
            hideModal(document.getElementById('editTaskModal'));
        });
    }
    
    // Show new task modal button
    const showNewTaskModalBtn = document.getElementById('showNewTaskModal');
    if (showNewTaskModalBtn) {
        showNewTaskModalBtn.addEventListener('click', function() {
            showModal(document.getElementById('newTaskModal'));
        });
    }

    // Populate assignee select for New Task when project changes
    const taskProjectSelect = document.getElementById('taskProject');
    const taskAssigneeSelect = document.getElementById('taskAssignee');
    function populateAssigneeSelect(selectEl, options, selectedId) {
        if (!selectEl) return;
        selectEl.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select Team Member';
        selectEl.appendChild(defaultOpt);
        options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt.id;
            o.textContent = opt.name + (opt.job_position ? ` (${opt.job_position})` : '');
            selectEl.appendChild(o);
        });
        if (selectedId) selectEl.value = selectedId;
    }

    if (taskProjectSelect && taskAssigneeSelect) {
        taskProjectSelect.addEventListener('change', function() {
            const projectId = this.value;
            if (!projectId) {
                taskAssigneeSelect.innerHTML = '<option value="">Select Team Member</option>';
                return;
            }
            fetch(`/api/projects/${projectId}/available-employees/?mode=members`)
                .then(r => r.json())
                .then(resp => {
                    if (resp.success && Array.isArray(resp.employees)) {
                        // If API indicates assigning to all is supported, add that option first
                        const options = resp.employees.slice();
                        if (resp.allow_assign_all) {
                            options.unshift({ id: 'all', name: 'All Team Members' });
                        }
                        populateAssigneeSelect(taskAssigneeSelect, options, '');
                    } else {
                        taskAssigneeSelect.innerHTML = '<option value="">No available members</option>';
                    }
                })
                .catch(err => {
                    console.error('Error fetching available employees:', err);
                    taskAssigneeSelect.innerHTML = '<option value="">No available members</option>';
                });
        });

        // Trigger change on load if a project is preselected
        if (taskProjectSelect.value) {
            const ev = new Event('change');
            taskProjectSelect.dispatchEvent(ev);
        }
    }
});

// Load task data for editing
function loadTaskForEditing(taskId) {
    fetch(`/api/tasks/${taskId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate form fields
                document.getElementById('editTaskId').value = data.task_id;
                document.getElementById('editTaskTitleInput').value = data.task_title;
                document.getElementById('editTaskDescription').value = data.description || '';
                document.getElementById('editTaskProject').value = data.project_id;
                // Populate assignee select from returned assignee_options
                (function() {
                    const assigneeEl = document.getElementById('editTaskAssignee');
                    if (!assigneeEl) return;
                    // clear existing options
                    assigneeEl.innerHTML = '';
                    const defaultOpt = document.createElement('option');
                    defaultOpt.value = '';
                    defaultOpt.textContent = 'Unassigned';
                    assigneeEl.appendChild(defaultOpt);
                    if (Array.isArray(data.assignee_options)) {
                        data.assignee_options.forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt.id;
                            o.textContent = opt.name + (opt.role ? ` (${opt.role})` : '');
                            assigneeEl.appendChild(o);
                        });
                    }
                    assigneeEl.value = data.assignee_id || '';
                })();
                document.getElementById('editTaskType').value = data.task_type || 'feature';
                document.getElementById('editTaskPriority').value = data.priority;
                document.getElementById('editTaskDueDate').value = data.due_date;
                document.getElementById('editTaskStatus').value = data.status;
                document.getElementById('editTaskEstimatedHours').value = data.estimated_hours || '';
                document.getElementById('editTaskActualHours').value = data.actual_hours || '';
                document.getElementById('editTaskProgress').value = data.progress || 0;
                document.getElementById('editTaskProgressValue').textContent = (data.progress || 0) + '%';
                
                // Update modal title
                document.getElementById('editTaskTitle').textContent = `Edit: ${data.task_title}`;
                
                // Show modal
                showModal(document.getElementById('editTaskModal'));
            } else {
                alert('Error loading task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading task data');
        });
}

// Update task
function updateTask() {
    const taskId = document.getElementById('editTaskId').value;
    const formData = {
        title: document.getElementById('editTaskTitleInput').value,
        description: document.getElementById('editTaskDescription').value,
        project_id: document.getElementById('editTaskProject').value,
        assigned_to: document.getElementById('editTaskAssignee').value || null,
        task_type: document.getElementById('editTaskType').value,
        priority: document.getElementById('editTaskPriority').value,
        due_date: document.getElementById('editTaskDueDate').value,
        status: document.getElementById('editTaskStatus').value,
        estimated_hours: document.getElementById('editTaskEstimatedHours').value || 0,
        actual_hours: document.getElementById('editTaskActualHours').value || 0,
        progress: document.getElementById('editTaskProgress').value || 0,
    };
    
    fetch(`/api/tasks/${taskId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideModal(document.getElementById('editTaskModal'));
            showSuccessModal('Task Updated', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task');
    });
}



// Approve task
function approveTask(taskId) {
    fetch(`/api/tasks/${taskId}/approve/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task_id: taskId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideModal(document.getElementById('confirmationModal'));
            showSuccessModal('Task Approved', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error approving task');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Success modal functions
function showSuccessModal(title, message) {
    if (title) document.getElementById('successTitle').textContent = title;
    if (message) document.getElementById('successMessage').textContent = message;
    showModal(document.getElementById('successModal'));
}

document.getElementById('closeSuccessBtn').addEventListener('click', function() {
    hideModal(document.getElementById('successModal'));
});

// Override base.html new task button to show our modal
document.addEventListener('DOMContentLoaded', function() {
    const newTaskBtn = document.getElementById('newTaskBtn');
    if (newTaskBtn) {
        newTaskBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showModal(document.getElementById('newTaskModal'));
        });
    }
});
</script>
{% endblock %}