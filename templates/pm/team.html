{% extends 'pm/base.html' %}

{% block page_title %}Team Management{% endblock %}

{% block header_button %}
<button id="addMemberBtn" class="bg-dark-teal text-white px-4 py-2 rounded-lg flex items-center">
    <i class="fas fa-user-plus mr-2"></i>
    <span>Add Member</span>
</button>
{% endblock %}

{% block content %}
    <!-- Filters and Search -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
            <div class="flex flex-wrap gap-2">
                <button class="filter-active px-3 py-1 rounded-full text-sm transition" data-role="">All Members</button>
                <button class="px-3 py-1 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition" data-role="dev">Developers</button>
                <button class="px-3 py-1 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition" data-role="designer">Designers</button>
                <button class="px-3 py-1 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition" data-role="qa">QA</button>
                <button class="px-3 py-1 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition" data-status="available">Available</button>
            </div>
            
            <div class="flex space-x-3 w-full md:w-auto">
                <div class="relative flex-1 md:w-64">
                    <input type="text" id="teamSearch" placeholder="Search team members..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-teal">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 flex items-center">
                    <i class="fas fa-filter mr-2"></i>
                    <span>Filters</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Team Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">Total Team</p>
                    <h3 class="text-2xl font-bold text-ink-black mt-1">{{ total_team_members }}</h3>
                </div>
                <div class="p-3 bg-dark-teal bg-opacity-10 rounded-lg">
                    <i class="fas fa-users text-dark-teal text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-4"><span class="text-dark-cyan font-medium">{{ available_members_count }} available</span></p>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">Developers</p>
                    <h3 class="text-2xl font-bold text-ink-black mt-1">{{ developers_count }}</h3>
                </div>
                <div class="p-3 bg-dark-cyan bg-opacity-10 rounded-lg">
                    <i class="fas fa-code text-dark-cyan text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-4"><span class="text-dark-cyan font-medium">{{ available_developers }} available</span></p>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">Designers</p>
                    <h3 class="text-2xl font-bold text-ink-black mt-1">{{ designers_count }}</h3>
                </div>
                <div class="p-3 bg-golden-orange bg-opacity-10 rounded-lg">
                    <i class="fas fa-palette text-golden-orange text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-4"><span class="text-dark-cyan font-medium">{{ available_designers }} available</span></p>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 text-sm">QA Engineers</p>
                    <h3 class="text-2xl font-bold text-ink-black mt-1">{{ qa_count }}</h3>
                </div>
                <div class="p-3 bg-rusty-spice bg-opacity-10 rounded-lg">
                    <i class="fas fa-vial text-rusty-spice text-xl"></i>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-4"><span class="text-dark-cyan font-medium">{{ available_qa }} available</span></p>
        </div>
    </div>
    
    <!-- Team Members Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-ink-black">Team Members</h3>
                <div class="flex items-center space-x-2">
                    <div class="relative w-48">
                        <select id="projectFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-teal">
                            <option value="">All Projects</option>
                            {% for project in managed_projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team Member</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Projects</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="teamMembersTable">
                    {% for member in team_members %}
                    <tr class="hover:bg-gray-50 transition member-row" data-role="{{ member.role }}" data-status="{{ member.workload_status }}" data-project-id="{{ member.primary_project_id|default:'' }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full {{ member.color_class }} flex items-center justify-center text-white font-bold">
                                    {{ member.initials }}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ member.name }}</div>
                                    <div class="text-sm text-gray-500">{{ member.job_position }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full role-{{ member.role }}">
                                {{ member.role_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ member.email }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex -space-x-2">
                                {% for project in member.projects %}
                                    {% if forloop.counter <= 3 %}
                                    <div class="w-8 h-8 rounded-full bg-{{ project.color }} flex items-center justify-center text-white text-xs font-bold border-2 border-white" title="{{ project.name }}">
                                        {{ project.initials }}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                                {% if member.project_count > 3 %}
                                    <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white text-xs font-bold border-2 border-white" title="And {{ member.project_count|add:'-3' }} more projects">
                                        +{{ member.project_count|add:'-3' }}
                                    </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full status-{{ member.workload_status }}">
                                {{ member.workload_status|title }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-dark-teal hover:text-dark-cyan mr-3 edit-member" 
                                    data-member-id="{{ member.employee_id }}"
                                    data-member-name="{{ member.name }}"
                                    data-current-role="{{ member.role }}"
                                    data-current-projects="{{ member.project_ids|join:',' }}">
                                <i class="fas fa-edit"></i>
                            </button>

                            <button class="text-gray-600 hover:text-gray-800 view-member" 
                                    title="View details"
                                    data-member-id="{{ member.employee_id }}"
                                    data-member-name="{{ member.name }}"
                                    data-member-email="{{ member.email }}"
                                    data-member-position="{{ member.job_position }}"
                                    data-member-projects-count="{{ member.project_count }}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-users text-4xl text-gray-300 mb-2"></i>
                                <p>No team members found.</p>
                                <p class="text-sm mt-1">Add team members to get started.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if team_members %}
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    Showing <span class="font-medium">{{ team_members|length }}</span> of <span class="font-medium">{{ total_team_members }}</span> team members
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Team Workload -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-ink-black">Team Workload</h3>
            <a href="{% url 'pm_reports' %}" class="text-dark-teal text-sm font-medium hover:text-dark-cyan">View Detailed Report</a>
        </div>
        
        <div class="space-y-4" id="workloadContainer">
            {% for member in team_members %}
            {% if member.active_tasks > 0 %}
            <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full {{ member.color_class }} flex items-center justify-center text-white font-bold mr-4">
                        {{ member.initials }}
                    </div>
                    <div>
                        <h4 class="font-medium">{{ member.name }}</h4>
                        <p class="text-sm text-gray-500">{{ member.job_position }}</p>
                    </div>
                </div>
                <div class="w-48">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Workload</span>
                        <span>{{ member.workload_percentage }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="{{ member.workload_color }} h-2 rounded-full" style="width: {{ member.workload_percentage }}%"></div>
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <span class="font-medium">{{ member.active_tasks }}</span> active tasks
                </div>
            </div>
            {% endif %}
            {% empty %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-tasks text-3xl text-gray-300 mb-2"></i>
                <p>No workload data available.</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
{% endblock %}

{% block extra_css %}
<style>
    .status-available { background-color: rgba(148, 210, 189, 0.1); color: #0a9396; }
    .status-busy { background-color: rgba(238, 155, 0, 0.1); color: #ee9b00; }
    .status-away { background-color: rgba(187, 62, 3, 0.1); color: #bb3e03; }
    .status-offline { background-color: rgba(128, 128, 128, 0.1); color: #666; }
    
    .role-dev { background-color: rgba(10, 147, 150, 0.1); color: #0a9396; }
    .role-designer { background-color: rgba(148, 210, 189, 0.1); color: #94d2bd; }
    .role-qa { background-color: rgba(187, 62, 3, 0.1); color: #bb3e03; }
    .role-analyst { background-color: rgba(0, 95, 115, 0.1); color: #005f73; }
    .role-pm { background-color: rgba(238, 155, 0, 0.1); color: #ee9b00; }
    .role-other { background-color: rgba(128, 128, 128, 0.1); color: #666; }
    
    .filter-active {
        background-color: #005f73;
        color: white;
    }
    /* Slide-over panel styles */
    .panel-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.28); z-index: 50; }
    .slide-over { position: fixed; top: 0; right: 0; height: 100%; width: 28rem; max-width: 100%; background: white; box-shadow: -8px 0 24px rgba(15,23,42,0.15); transform: translateX(100%); transition: transform 0.28s ease-in-out; z-index: 60; overflow-y: auto; }
    .slide-over.open { transform: translateX(0); }
</style>
{% endblock %}

{% block extra_js %}
<!-- Add Team Member Modal -->
<div id="addMemberModal" class="modal">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-ink-black">Add Team Member</h3>
        </div>
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Project</label>
                <select id="selectedProject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required>
                    <option value="">Choose a project</option>
                    {% for project in managed_projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Employee</label>
                <select id="selectedEmployee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal" required disabled>
                    <option value="">Choose an employee</option>
                </select>
                <p class="text-xs text-gray-500 mt-2" id="employeeCount">No project selected</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <select id="memberRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal">
                    <option value="dev">Developer</option>
                    <option value="designer">Designer</option>
                    <option value="qa">QA Engineer</option>
                    <option value="analyst">Business Analyst</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div id="employeeDetails" class="mb-4 p-3 bg-gray-50 rounded-lg" style="display: none;">
                <h4 class="font-medium mb-2" id="employeeName"></h4>
                <p class="text-sm text-gray-600 mb-1" id="employeePosition"></p>
                <p class="text-sm text-gray-600 mb-1" id="employeeDepartment"></p>
                <p class="text-sm text-gray-600" id="employeeSkills"></p>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancelAddMemberBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="button" id="confirmAddMemberBtn" class="px-4 py-2 bg-dark-teal text-white rounded-md hover:bg-dark-cyan">Add Member</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Team Member Modal -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-xl font-bold text-ink-black">Edit Team Member</h3>
        </div>
        <div class="p-6">
            <input type="hidden" id="editEmployeeId">
            <input type="hidden" id="editProjectIds">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Team Member</label>
                <p class="text-gray-800 font-medium" id="editMemberName"></p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Projects</label>
                <div id="currentProjectsList" class="space-y-2 mb-3">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add to More Projects</label>
                <div class="flex space-x-2">
                    <select id="addToProject" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal">
                        <option value="">Select project to add</option>
                        {% for project in managed_projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                    <select id="addProjectRole" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-dark-teal">
                        <option value="dev">Developer</option>
                        <option value="designer">Designer</option>
                    </select>
                    <button id="addProjectBtn" class="px-3 py-2 bg-dark-teal text-white rounded-md hover:bg-dark-cyan">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancelEditMemberBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="button" id="saveEditMemberBtn" class="px-4 py-2 bg-dark-teal text-white rounded-md hover:bg-dark-cyan">Save Changes</button>
            </div>
        </div>
    </div>
</div>

        <!-- Slide-over Team Member Panel (keeps table visible) -->
        <div id="panelOverlay" class="panel-overlay" style="display:none;" onclick="hidePanel(document.getElementById('viewMemberPanel'))"></div>
        <aside id="viewMemberPanel" class="slide-over" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <h3 id="slide-over-title" class="text-xl font-bold text-ink-black">Member Details</h3>
                    <button aria-label="Close panel" id="closeViewMemberPanel" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
            </div>
            <div class="p-6">
                <h4 id="viewMemberName" class="font-medium text-lg mb-1"></h4>
                <p id="viewMemberPosition" class="text-sm text-gray-600 mb-1"></p>
                <p id="viewMemberEmail" class="text-sm text-gray-600 mb-3"></p>
                <p class="text-sm text-gray-600">Projects: <span id="viewMemberProjectsCount"></span></p>
                <div class="mt-4">
                    <h4 class="font-medium mb-2">Assigned Tasks</h4>
                    <div id="viewMemberTasks" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </aside>

        <script>
    // Filter buttons functionality
    const filterButtons = document.querySelectorAll('[data-role], [data-status]');
    const memberRows = document.querySelectorAll('.member-row');
    const searchInput = document.getElementById('teamSearch');
    const projectFilter = document.getElementById('projectFilter');
    
    let currentRoleFilter = '';
    let currentStatusFilter = '';
    let currentProjectFilter = '';
    let currentSearch = '';

    // Helper to escape HTML when inserting untrusted strings
    function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => {
                btn.classList.remove('filter-active', 'bg-dark-teal', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            // Add active class to clicked button
            this.classList.remove('bg-gray-100', 'text-gray-700');
            this.classList.add('filter-active', 'bg-dark-teal', 'text-white');
            
            // Update filters
            if (this.hasAttribute('data-role')) {
                currentRoleFilter = this.getAttribute('data-role');
            } else if (this.hasAttribute('data-status')) {
                currentStatusFilter = this.getAttribute('data-status');
            }
            
            filterTeamMembers();
        });
    });
    
    projectFilter.addEventListener('change', function() {
        currentProjectFilter = this.value;
        filterTeamMembers();
    });
    
    searchInput.addEventListener('input', function() {
        currentSearch = this.value.toLowerCase();
        filterTeamMembers();
    });
    
    function filterTeamMembers() {
        let visibleCount = 0;
        
        memberRows.forEach(row => {
            const role = row.getAttribute('data-role');
            const status = row.getAttribute('data-status');
            const projectId = row.getAttribute('data-project-id');
            const name = row.querySelector('.text-gray-900').textContent.toLowerCase();
            const position = row.querySelector('.text-gray-500').textContent.toLowerCase();
            
            const roleMatch = !currentRoleFilter || role === currentRoleFilter;
            const statusMatch = !currentStatusFilter || status === currentStatusFilter;
            const projectMatch = !currentProjectFilter || (projectId && projectId.includes(currentProjectFilter));
            const searchMatch = !currentSearch || 
                               name.includes(currentSearch) || 
                               position.includes(currentSearch) ||
                               row.querySelectorAll('.text-gray-500')[1]?.textContent.toLowerCase().includes(currentSearch);
            
            if (roleMatch && statusMatch && projectMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update showing count
        const showingElement = document.querySelector('.bg-gray-50 .font-medium');
        if (showingElement) {
            showingElement.textContent = visibleCount;
        }
    }
    
    // Modal functionality
    const addMemberModal = document.getElementById('addMemberModal');
    const editMemberModal = document.getElementById('editMemberModal');
    
    // Show Add Member modal
    document.getElementById('addMemberBtn').addEventListener('click', () => {
        showModal(addMemberModal);
        loadAvailableEmployeesForAllProjects();
    });
    
    // Load available employees for all projects
    function loadAvailableEmployeesForAllProjects() {
        const projectSelect = document.getElementById('selectedProject');
        const employeeSelect = document.getElementById('selectedEmployee');
        
        projectSelect.addEventListener('change', function() {
            const projectId = this.value;
            if (projectId) {
                fetch(`/api/projects/${projectId}/available-employees/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            employeeSelect.innerHTML = '<option value="">Choose an employee</option>';
                            data.employees.forEach(employee => {
                                const option = document.createElement('option');
                                option.value = employee.id;
                                option.textContent = employee.name;
                                option.setAttribute('data-email', employee.email);
                                option.setAttribute('data-position', employee.job_position);
                                option.setAttribute('data-department', employee.department);
                                option.setAttribute('data-skills', employee.skills);
                                employeeSelect.appendChild(option);
                            });
                            employeeSelect.disabled = false;
                            document.getElementById('employeeCount').textContent = `${data.employees.length} available employees`;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading available employees:', error);
                        document.getElementById('employeeCount').textContent = 'Error loading employees';
                    });
            } else {
                employeeSelect.innerHTML = '<option value="">Choose an employee</option>';
                employeeSelect.disabled = true;
                document.getElementById('employeeCount').textContent = 'No project selected';
            }
        });
    }
    
    // Employee selection change in Add modal
    document.getElementById('selectedEmployee')?.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const detailsDiv = document.getElementById('employeeDetails');
        
        if (selectedOption.value) {
            document.getElementById('employeeName').textContent = selectedOption.textContent;
            document.getElementById('employeePosition').textContent = selectedOption.getAttribute('data-position');
            document.getElementById('employeeDepartment').textContent = selectedOption.getAttribute('data-department');
            document.getElementById('employeeSkills').textContent = selectedOption.getAttribute('data-skills') || 'No skills specified';
            detailsDiv.style.display = 'block';
        } else {
            detailsDiv.style.display = 'none';
        }
    });
    
    // Add member confirmation
    document.getElementById('confirmAddMemberBtn').addEventListener('click', function() {
        const projectId = document.getElementById('selectedProject').value;
        const employeeId = document.getElementById('selectedEmployee').value;
        const role = document.getElementById('memberRole').value;
        
        if (!projectId) {
            alert('Please select a project');
            return;
        }
        
        if (!employeeId) {
            alert('Please select an employee');
            return;
        }
        
        const data = {
            project_id: projectId,
            employee_id: employeeId,
            role: role
        };
        
        fetch('/api/team/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showSuccessModal('Team member added successfully!', 'The team member has been added to the project.');
                hideModal(addMemberModal);
                
                // Reload page after a delay to show updated team
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the team member');
        });
    });
    
    // Edit member buttons
    document.querySelectorAll('.edit-member').forEach(button => {
        button.addEventListener('click', function(event) {
            // prevent click bubbling that may trigger other UI handlers
            event.stopPropagation();
            event.preventDefault();
            const memberId = this.getAttribute('data-member-id');
            const memberName = this.getAttribute('data-member-name');
            const currentRole = this.getAttribute('data-current-role');
            const projectIds = this.getAttribute('data-current-projects');
            
            // Set modal data
            document.getElementById('editEmployeeId').value = memberId;
            document.getElementById('editMemberName').textContent = memberName;
            document.getElementById('editProjectIds').value = projectIds;
            
            // Load current projects
            loadCurrentProjects(memberId, projectIds);
            
            // ensure all rows visible when editing
            try { document.querySelectorAll('.member-row').forEach(r => { r.style.display = ''; }); } catch(e){}
            showModal(editMemberModal);
        });
    });

    // Prevent row clicks from bubbling to other handlers that may hide rows
    document.querySelectorAll('.member-row').forEach(row => {
        row.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });

    // View member buttons - fetch detailed member info from server (slide-over panel)
    const viewMemberPanel = document.getElementById('viewMemberPanel');
    const panelOverlay = document.getElementById('panelOverlay');
    document.querySelectorAll('.view-member').forEach(button => {
        button.addEventListener('click', function(event) {
            // prevent click bubbling that may trigger other UI handlers
            event.stopPropagation();
            event.preventDefault();
            const memberId = this.getAttribute('data-member-id');
            // find project id from the closest row
            const row = this.closest('.member-row');
            const projectId = row ? row.getAttribute('data-project-id') : null;

            const nameEl = document.getElementById('viewMemberName');
            const emailEl = document.getElementById('viewMemberEmail');
            const positionEl = document.getElementById('viewMemberPosition');
            const projectsEl = document.getElementById('viewMemberProjectsCount');

            if (!memberId || !projectId) {
                if (nameEl) nameEl.textContent = 'Member details unavailable';
                if (emailEl) emailEl.textContent = '';
                if (positionEl) positionEl.textContent = '';
                if (projectsEl) projectsEl.textContent = '';
                showPanel(viewMemberPanel);
                return;
            }

            fetch(`/api/projects/${projectId}/team-member/${memberId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (nameEl) nameEl.textContent = data.employee_name || '';
                        if (emailEl) emailEl.textContent = data.email || '';
                        if (positionEl) positionEl.textContent = data.position || '';
                        if (projectsEl) projectsEl.textContent = data.project_name ? `${data.project_name} ` : (data.project_id || '0');
                                // Render assigned tasks
                                const tasksContainer = document.getElementById('viewMemberTasks');
                                console.log('Assigned tasks data:', data.assigned_tasks);
                                if (tasksContainer) {
                                    tasksContainer.innerHTML = '';
                                    if (data.assigned_tasks && data.assigned_tasks.length) {
                                        data.assigned_tasks.forEach(t => {
                                            const taskEl = document.createElement('div');
                                            taskEl.className = 'p-3 border border-gray-100 rounded';
                                            const dueText = t.due_date ? `Due ${t.due_date}` : 'No due date';
                                            taskEl.innerHTML = `
                                                <div class="flex justify-between items-center mb-2">
                                                    <div class="font-medium">${escapeHtml(t.title)}</div>
                                                    <div class="text-sm text-gray-500">${escapeHtml(t.status_display || t.status || '')}</div>
                                                </div>
                                                <div class="text-sm text-gray-500 mb-2">${escapeHtml(dueText)}</div>
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="bg-dark-teal h-2 rounded-full" style="width: ${Number(t.progress || 0)}%"></div>
                                                </div>
                                            `;
                                            tasksContainer.appendChild(taskEl);
                                        });
                                    } else {
                                        tasksContainer.innerHTML = '<p class="text-sm text-gray-500">No assigned tasks.</p>';
                                    }
                                }
                    } else {
                        if (nameEl) nameEl.textContent = 'Unable to load member details';
                        if (emailEl) emailEl.textContent = '';
                        if (positionEl) positionEl.textContent = '';
                        if (projectsEl) projectsEl.textContent = '';
                    }

                    showPanel(viewMemberPanel);
                })
                .catch(err => {
                    console.error('Error fetching member details:', err);
                    if (nameEl) nameEl.textContent = 'Error loading details';
                    if (emailEl) emailEl.textContent = '';
                    if (positionEl) positionEl.textContent = '';
                    if (projectsEl) projectsEl.textContent = '';
                    showPanel(viewMemberPanel);
                });
        });
    });
    
    // Load current projects for edit modal
    function loadCurrentProjects(employeeId, projectIds) {
        const projectsList = document.getElementById('currentProjectsList');
        projectsList.innerHTML = '';
        
        if (!projectIds) return;
        
        const projectIdArray = projectIds.split(',');
        
        // For each project, create a project item
        projectIdArray.forEach(projectId => {
            if (projectId) {
                fetch(`/api/projects/${projectId}/team-member/${employeeId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const projectDiv = document.createElement('div');
                            projectDiv.className = 'flex justify-between items-center p-2 border border-gray-200 rounded';
                            projectDiv.innerHTML = `
                                <div>
                                    <span class="font-medium">${data.project_name}</span>
                                    <span class="text-sm text-gray-500 ml-2">(${data.role_display})</span>
                                </div>
                                <button class="text-rusty-spice hover:text-oxidized-iron remove-from-project" 
                                        data-project-id="${projectId}" 
                                        data-employee-id="${employeeId}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            projectsList.appendChild(projectDiv);
                            
                            // Add event listener to remove button
                            projectDiv.querySelector('.remove-from-project').addEventListener('click', function() {
                                const projId = this.getAttribute('data-project-id');
                                const empId = this.getAttribute('data-employee-id');
                                removeFromProject(projId, empId);
                            });
                        }
                    })
                    .catch(error => console.error('Error loading project details:', error));
            }
        });
    }
    
    // Add project button in edit modal
    document.getElementById('addProjectBtn').addEventListener('click', function() {
        const projectId = document.getElementById('addToProject').value;
        const employeeId = document.getElementById('editEmployeeId').value;
        const role = document.getElementById('addProjectRole').value;
        
        if (!projectId) {
            alert('Please select a project to add');
            return;
        }
        
        const data = {
            project_id: projectId,
            employee_id: employeeId,
            role: role
        };
        
        fetch('/api/team/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload current projects
                const currentProjects = document.getElementById('editProjectIds').value;
                const newProjects = currentProjects ? currentProjects + ',' + projectId : projectId;
                document.getElementById('editProjectIds').value = newProjects;
                loadCurrentProjects(employeeId, newProjects);
                
                // Reset add project form
                document.getElementById('addToProject').value = '';
                document.getElementById('addProjectRole').value = 'dev';
                
                showSuccessModal('Added to project!', 'Team member has been added to the new project.');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding to project');
        });
    });
    
    // Remove from project function
    function removeFromProject(projectId, employeeId) {
        if (confirm('Remove this team member from the project? They will no longer have access to project tasks.')) {
            const data = {
                project_id: projectId,
                employee_id: employeeId
            };
            
            fetch('/api/team/remove/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update current projects list
                    const currentProjectIds = document.getElementById('editProjectIds').value;
                    const projectIdsArray = currentProjectIds.split(',').filter(id => id !== projectId);
                    document.getElementById('editProjectIds').value = projectIdsArray.join(',');
                    
                    // Reload projects list
                    loadCurrentProjects(employeeId, projectIdsArray.join(','));
                    
                    showSuccessModal('Removed from project!', 'Team member has been removed from the project.');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while removing from project');
            });
        }
    }
    
    // Save edit changes
    document.getElementById('saveEditMemberBtn').addEventListener('click', function() {
        hideModal(editMemberModal);
        showSuccessModal('Changes saved!', 'Team member information has been updated.');
        
        // Reload page after a delay to show updated team
        setTimeout(() => {
            location.reload();
        }, 1500);
    });
    
    // Hide modals
    document.getElementById('cancelAddMemberBtn').addEventListener('click', () => hideModal(addMemberModal));
    document.getElementById('cancelEditMemberBtn').addEventListener('click', () => hideModal(editMemberModal));
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            hideModal(event.target);
        }
    });
    
    // Modal helper functions
    function showModal(modal) {
        if (modal) modal.style.display = 'flex';
        // Ensure all member rows visible when opening any modal
        try { document.querySelectorAll('.member-row').forEach(r => { r.style.display = ''; }); } catch (e) {}
    }
    
    function hideModal(modal) {
        if (modal) modal.style.display = 'none';
    }

    // Slide-over panel helper functions
    function showPanel(panel) {
        if (!panel) return;
        panel.classList.add('open');
        if (panelOverlay) panelOverlay.style.display = 'block';
        // prevent body scroll while panel open
        document.body.style.overflow = 'hidden';
        // Ensure all member rows remain visible when panel opens
        try {
            document.querySelectorAll('.member-row').forEach(r => { r.style.display = ''; });
        } catch (e) {
            // ignore
        }
    }

    function hidePanel(panel) {
        if (!panel) return;
        panel.classList.remove('open');
        if (panelOverlay) panelOverlay.style.display = 'none';
        document.body.style.overflow = '';
    }
    
    function showSuccessModal(title, message) {
        // Use the existing success modal from base.html if available
        const successModal = document.getElementById('successModal');
        if (successModal) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            successModal.style.display = 'flex';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                successModal.style.display = 'none';
            }, 3000);
        } else {
            alert(title + ': ' + message);
        }
    }
    
    // CSRF token helper
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Initialize filtering
    filterTeamMembers();

    // Close button for slide-over panel
    document.getElementById('closeViewMemberPanel')?.addEventListener('click', function() {
        hidePanel(document.getElementById('viewMemberPanel'));
    });
</script>
{% endblock %}